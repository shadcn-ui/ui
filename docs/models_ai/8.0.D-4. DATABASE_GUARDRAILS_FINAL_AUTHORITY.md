# DATABASE LAYER CONTROL GUARDRAILS
## Non-Bypassable Data Enforcement Rules

**Document Classification**: Technical Control Specification — Database Layer  
**Effective Date**: January 6, 2026  
**Authority**: Chief Technology Officer, Database Administrator, Chief Information Security Officer  
**Scope**: Database Layer Only (PostgreSQL)

---

## 1. WRITE PERMISSION RULES

### Control State: NORMAL

**INSERT Operations:**
- Finance tables: MUST have approval_id foreign key populated
- HR tables: MUST have approval_id and dual_approval_id foreign keys populated
- Operations tables: MUST have approval_id OR autonomy_threshold_satisfied flag
- Commerce tables: MUST have approval_id OR within_credit_limit flag
- Retail tables: MUST have approval_id OR within_policy_rules flag
- Intelligence tables: NEVER permitted (architectural read-only)
- Audit tables: MUST be system-generated only (no application INSERT)

**UPDATE Operations:**
- Posted financial records: NEVER permitted
- Posted HR records: NEVER permitted
- Committed transactions: NEVER permitted
- Audit logs: NEVER permitted
- Control state history: NEVER permitted
- Approval records: NEVER permitted after approval granted
- Intelligence tables: NEVER permitted (architectural read-only)

**DELETE Operations:**
- Posted financial records: NEVER permitted
- Posted HR records: NEVER permitted
- Audit logs: NEVER permitted
- Control state history: NEVER permitted
- Approval records: NEVER permitted
- All domains: MUST use soft delete (is_deleted flag) for operational records
- Hard DELETE: Permitted only for draft/pending records with justification audit

---

### Control State: SUPERVISED_AUTONOMY

**INSERT Operations:**
- Finance tables: MUST have approval_id (unchanged from NORMAL)
- HR tables: MUST have approval_id and dual_approval_id (unchanged from NORMAL)
- Operations tables: MUST have approval_id (autonomous threshold reduced)
- Commerce tables: MUST have approval_id (autonomous threshold reduced to $5,000)
- Retail tables: MUST have approval_id (autonomous threshold reduced to $500)
- Intelligence tables: NEVER permitted
- Background job INSERT: MUST have explicit authorization flag

**UPDATE Operations:**
- All rules from NORMAL apply (unchanged)

**DELETE Operations:**
- All rules from NORMAL apply (unchanged)

---

### Control State: MANUAL_ONLY

**INSERT Operations:**
- ALL tables: MUST have approval_id foreign key populated
- Finance tables: MUST have approval_id (unchanged)
- HR tables: MUST have approval_id and dual_approval_id (unchanged)
- Operations tables: MUST have approval_id (no autonomous threshold exception)
- Commerce tables: MUST have approval_id (no autonomous threshold exception)
- Retail tables: MUST have approval_id (no autonomous threshold exception)
- Intelligence tables: NEVER permitted
- No autonomous INSERT permitted regardless of threshold or flags

**UPDATE Operations:**
- All rules from NORMAL apply
- Draft/pending records: MUST have approval_id for all modifications

**DELETE Operations:**
- All rules from NORMAL apply
- Draft/pending records: MUST have approval_id for all deletions

---

### Control State: KILL_SWITCH_ACTIVE

**INSERT Operations:**
- ALL tables: MUST have executive_authorization_id foreign key populated
- Finance tables: BLOCKED unless executive_authorization_id present
- HR tables: BLOCKED unless executive_authorization_id present
- Operations tables: BLOCKED unless executive_authorization_id present
- Commerce tables: BLOCKED unless executive_authorization_id present
- Retail tables: BLOCKED unless executive_authorization_id present
- Intelligence tables: NEVER permitted
- Audit tables: Permitted for system audit logging only

**UPDATE Operations:**
- ALL tables: BLOCKED unconditionally
- Executive corrections: Permitted only via dedicated correction tables with full audit trail
- Posted records: NEVER modifiable (reversal-only via INSERT)

**DELETE Operations:**
- ALL tables: BLOCKED unconditionally
- No exceptions

---

### Domain-Permanent Rules (ALL CONTROL STATES)

**Finance Domain Tables:**
- INSERT: MUST have approval_id foreign key referencing approvals table
- INSERT: MUST have journal_date within open accounting period
- INSERT: MUST have balanced debits and credits (trigger validation)
- UPDATE of posted records: NEVER permitted
- DELETE of posted records: NEVER permitted
- UPDATE of draft records: Permitted with approval_id
- DELETE of draft records: Permitted with approval_id (soft delete only)

**Human Capital Domain Tables:**
- INSERT: MUST have approval_id AND dual_approval_id foreign keys
- INSERT to payroll tables: MUST have payroll_director_approval AND cfo_approval
- UPDATE of posted payroll: NEVER permitted
- DELETE of any employee record: NEVER permitted (soft delete only)
- UPDATE of draft records: Permitted with dual approval_id

**Intelligence Domain Tables:**
- INSERT: NEVER permitted from application layer
- UPDATE: NEVER permitted from application layer
- DELETE: NEVER permitted from application layer
- All operations: Read-only enforced by database role permissions (no GRANT INSERT/UPDATE/DELETE)

---

## 2. LEDGER & IMMUTABILITY RULES

### Append-Only Tables (NEVER UPDATE/DELETE)

**MUST be append-only:**
- audit_logs
- control_state_history
- approval_workflow_history
- financial_journal_entries (once posted_at IS NOT NULL)
- payroll_execution_history (once executed_at IS NOT NULL)
- transaction_ledger
- inventory_movements (once committed_at IS NOT NULL)
- kill_switch_activation_log
- executive_authorization_log
- integration_audit_trail

**Enforcement:**
- Database triggers MUST reject UPDATE on append-only tables
- Database triggers MUST reject DELETE on append-only tables
- Triggers MUST raise exception with error code and audit trail entry
- No database role (including admin) granted UPDATE/DELETE privileges on append-only tables

---

### Posted Record Immutability

**Posted Financial Records:**
- Status: posted_at IS NOT NULL
- UPDATE: NEVER permitted
- DELETE: NEVER permitted
- Correction mechanism: INSERT reversal entry with references original_entry_id
- Trigger enforcement: BEFORE UPDATE/DELETE trigger raises exception

**Posted HR Records:**
- Status: executed_at IS NOT NULL OR approved_at IS NOT NULL
- UPDATE: NEVER permitted
- DELETE: NEVER permitted
- Correction mechanism: INSERT correction record with references original_record_id

**Committed Operational Records:**
- Status: committed_at IS NOT NULL OR locked_at IS NOT NULL
- UPDATE: Permitted only for non-material fields (notes, tags, metadata)
- Material fields: NEVER updatable after commit
- DELETE: NEVER permitted

---

### Reversal-Only Correction Rule

**Financial Corrections:**
- MUST create reversal journal entry
- MUST reference original entry via original_journal_entry_id
- MUST include reversal_reason (minimum 20 characters)
- MUST have approval_id for reversal approval
- MUST have matching absolute amounts (opposite signs)
- Trigger MUST validate reversal references valid posted entry

**Payroll Corrections:**
- MUST create correction payroll entry
- MUST reference original payroll via original_payroll_id
- MUST include correction_reason and legal_review_required flag
- MUST have dual_approval_id for correction approval
- MUST be reported separately in payroll reconciliation

**Operational Corrections:**
- MUST create adjustment record
- MUST reference original transaction via original_transaction_id
- MUST include adjustment_reason
- MUST have manager_approval_id

---

### Soft Delete Enforcement

**Operational Tables:**
- Hard DELETE: NEVER permitted on tables with business data
- Soft delete: MUST set is_deleted = TRUE and deleted_at = NOW()
- Trigger enforcement: BEFORE DELETE trigger converts to UPDATE setting flags
- Query filtering: Application layer MUST filter WHERE is_deleted = FALSE
- Audit trail: Soft delete MUST log deleting_user_id and deletion_reason

**Exceptions (Hard DELETE Permitted):**
- Session tables (ephemeral data)
- Cache tables (ephemeral data)
- Staging tables (pre-validation data)
- Test data in non-production environments only

---

## 3. FAIL-CLOSED BEHAVIOR

### Control State Resolution Failure

**Trigger cannot read control state:**
- MUST assume KILL_SWITCH_ACTIVE state
- MUST block all INSERT/UPDATE/DELETE operations
- MUST raise exception with error code CONTROL_STATE_UNAVAILABLE
- MUST log failure to database error log
- MUST NOT proceed with operation

**NEVER:**
- Assume NORMAL state
- Proceed without control state validation
- Cache control state beyond 5 seconds
- Disable control state check

---

### Trigger Evaluation Failure

**Trigger encounters error during execution:**
- MUST abort transaction immediately
- MUST rollback all changes in transaction
- MUST raise exception with error details
- MUST log failure to audit trail (if audit trail accessible)
- MUST NOT allow partial transaction commit

**Error scenarios:**
- Foreign key validation failure: Transaction MUST rollback
- Constraint violation: Transaction MUST rollback
- Approval validation failure: Transaction MUST rollback
- Balance validation failure: Transaction MUST rollback
- Immutability violation: Transaction MUST rollback

---

### Partial Database Outage

**Replica unavailable:**
- Write operations to primary MUST proceed (writes always to primary)
- Read operations MUST fail over to available replicas
- Audit logging MUST continue on primary
- Control state reads MUST continue on primary

**Primary unavailable:**
- All write operations MUST be blocked
- Failover to replica promoted to primary within 30-60 seconds
- No writes permitted until primary available
- No degraded mode permitting unvalidated writes

**Audit table unavailable:**
- ALL write operations MUST be blocked immediately
- Transaction MUST rollback if audit insert fails
- No operation proceeds without audit trail
- Critical alert triggered immediately

---

### Foreign Key Validation Failure

**Approval ID validation:**
- INSERT lacking valid approval_id foreign key: MUST be rejected
- INSERT with expired approval: MUST be rejected (approval_expires_at < NOW())
- Transaction MUST rollback
- Error message MUST indicate missing or invalid approval

**Executive Authorization validation:**
- INSERT during KILL_SWITCH_ACTIVE lacking executive_authorization_id: MUST be rejected
- INSERT with invalid authorization: MUST be rejected
- Transaction MUST rollback
- Error message MUST indicate kill-switch active and authorization required

---

## 4. BYPASS PREVENTION

### Application Role Restrictions

**Application database role MUST NOT:**
- Have SUPERUSER privilege
- Have ability to disable triggers
- Have ability to modify trigger definitions
- Have ability to DROP constraints
- Have ability to ALTER TABLE to remove protections
- Have ability to UPDATE/DELETE append-only tables
- Have ability to TRUNCATE protected tables
- Have ability to modify audit_logs table

**Application role MUST:**
- Execute all operations through triggers and constraints
- Be subject to row-level security policies
- Be subject to column-level permissions
- Be subject to immutability protections
- Generate audit trail for all operations

---

### Superuser/Admin Restrictions

**Database superuser MUST NOT:**
- Modify protected tables during normal operations
- Disable triggers on production tables
- Modify posted/committed records directly
- Delete audit logs
- Modify control state without authorization
- Bypass approval requirements

**Permitted superuser operations:**
- Emergency disaster recovery with full audit trail and Board notification
- Database maintenance during scheduled downtime with change control approval
- Infrastructure migration with DBA approval and testing validation
- Performance optimization not affecting data integrity

**Enforcement:**
- Superuser actions logged to separate infrastructure audit log
- Superuser actions outside maintenance windows trigger immediate alert
- Quarterly review of superuser action logs by Internal Audit
- External audit validates superuser activity during control testing

---

### Background Jobs and Migrations

**Background jobs MUST:**
- Use same application database role (no elevated privileges)
- Execute through same triggers and constraints
- Respect control state at execution time
- Have approval_id for write operations during MANUAL_ONLY
- Be blocked during KILL_SWITCH_ACTIVE

**Background jobs MUST NOT:**
- Use superuser credentials
- Bypass triggers
- Directly modify protected tables
- Disable constraints temporarily

**Database migrations MUST:**
- Execute during scheduled maintenance window
- Have change control approval
- Preserve all trigger and constraint protections
- Maintain audit trail continuity
- Test in non-production environment first
- Validate no posted/committed record modifications

**Migration enforcement:**
- Migrations MUST NOT DROP immutability triggers
- Migrations MUST NOT modify append-only table data
- Migrations MUST NOT disable audit logging
- Schema changes require DBA review and CTO approval

---

### Direct SQL Access Prevention

**Database access control:**
- Application services MUST connect via application role only
- No service account granted superuser privilege
- No service account granted trigger disable privilege
- Direct SQL tools (psql, pgAdmin) require MFA authentication for production
- Direct SQL access logged and monitored

**Developer access:**
- Read-only access to production database via dedicated role
- No write access to production from development tools
- Emergency write access requires dual approval (DBA + CTO)
- All direct SQL operations audited

---

## 5. AUDIT GUARANTEES

### Blocked Operation Audit Requirements

**EVERY blocked operation MUST log:**
- Timestamp (microsecond precision with timezone)
- Operation type (INSERT/UPDATE/DELETE/TRUNCATE)
- Table name and schema
- Control state at time of operation
- Blocking reason code (CONTROL_STATE_VIOLATION, DOMAIN_AUTHORITY_VIOLATION, IMMUTABILITY_VIOLATION, etc.)
- Blocking reason detail (human-readable explanation)
- Authenticated user/role identity
- Application service identity (if service account)
- Source IP address (if available)
- Correlation ID (request trace ID)
- Transaction ID (database transaction identifier)
- Attempted operation SQL (sanitized, parameters removed)

**Log destination:**
- Dedicated audit_blocked_operations table
- Append-only (no UPDATE/DELETE permitted)
- Separate tablespace for isolation
- Replicated to audit data warehouse

---

### Permitted Operation Audit Requirements

**EVERY permitted write operation MUST log:**
- Timestamp (microsecond precision with timezone)
- Operation type (INSERT/UPDATE/DELETE)
- Table name and schema
- Primary key of affected record
- Control state at time of operation
- Domain and autonomy level
- Approval ID (if approval required)
- Executive authorization ID (if during KILL_SWITCH_ACTIVE)
- Authenticated user/role identity
- Application service identity
- Source IP address
- Correlation ID
- Transaction ID
- Before values (for UPDATE operations, JSON format)
- After values (for INSERT/UPDATE operations, JSON format)

**Log destination:**
- Dedicated audit_write_operations table
- Append-only (no UPDATE/DELETE permitted)
- Separate tablespace for isolation
- Replicated to audit data warehouse

---

### Forensic Traceability Minimum Fields

**EVERY audit record MUST include:**
- event_id (UUID primary key)
- event_timestamp (timestamptz with microsecond precision)
- control_state (NORMAL/SUPERVISED_AUTONOMY/MANUAL_ONLY/KILL_SWITCH_ACTIVE)
- domain (Finance/HR/Operations/Commerce/Retail/Intelligence/System)
- operation_type (INSERT/UPDATE/DELETE/TRUNCATE/SELECT)
- table_name (fully qualified schema.table)
- record_id (primary key of affected record if applicable)
- correlation_id (UUID linking related operations)
- transaction_id (database transaction ID)
- user_identity (authenticated user email or service account)
- user_role (database role name)
- source_ip (IPv4/IPv6 address)
- outcome (PERMITTED/DENIED/ERROR)
- denial_reason_code (if DENIED)
- denial_reason_detail (if DENIED)
- approval_id (foreign key if approval-gated operation)
- executive_authorization_id (foreign key if executive-authorized operation)

---

### Retention and Immutability

**Audit log retention:**
- Minimum 7 years for financial audit logs
- Minimum 7 years for HR audit logs
- Minimum 3 years for operational audit logs
- Minimum 10 years for control state history
- Minimum 10 years for approval workflow history
- Permanent retention for kill-switch activation logs

**Immutability enforcement:**
- Database triggers MUST prevent UPDATE on all audit tables
- Database triggers MUST prevent DELETE on all audit tables
- Triggers MUST prevent TRUNCATE on all audit tables
- No database role granted UPDATE/DELETE on audit tables
- Superuser modifications trigger immediate alert and investigation

**Tamper detection:**
- Audit records include cryptographic hash of record content
- Hash chain links each record to previous record
- Quarterly integrity validation by Internal Audit
- External audit validates audit log integrity during control testing

**Archival:**
- Audit logs older than 2 years moved to WORM storage
- WORM storage prevents modification and deletion architecturally
- Archived logs accessible for investigation and regulatory response
- Archive restoration tested quarterly

---

## ENFORCEMENT PRINCIPLES

### Trigger Execution Order

**BEFORE triggers (validation):**
1. Control state validation
2. Domain authority validation
3. Approval requirement validation
4. Immutability protection validation
5. Business rule validation (balance, date range, etc.)
6. Constraint validation

**AFTER triggers (audit):**
1. Audit log record generation
2. Control state history update (if state change)
3. Notification generation (if required)

**Failure at ANY trigger stage:**
- Transaction MUST rollback completely
- No partial data modifications permitted
- Audit log records failure (if audit accessible)

---

### Database Constraint Hierarchy

**Level 1: NOT NULL constraints**
- Mandatory fields MUST be populated
- Trigger validation supplements NOT NULL constraints

**Level 2: CHECK constraints**
- Value ranges MUST be valid
- Status transitions MUST be logical
- Date ranges MUST be consistent

**Level 3: FOREIGN KEY constraints**
- approval_id MUST reference valid approval
- executive_authorization_id MUST reference valid authorization
- Referential integrity MUST be maintained

**Level 4: UNIQUE constraints**
- Correlation IDs MUST be unique per operation
- Transaction IDs MUST be unique per transaction

**Level 5: TRIGGER constraints**
- Control state rules MUST be enforced
- Immutability rules MUST be enforced
- Audit logging MUST succeed

---

### Zero-Trust Database Architecture

**Database layer MUST enforce:**
- Control state validation (does not trust application)
- Domain authority validation (does not trust application)
- Approval validation (does not trust application)
- Immutability protection (does not trust application)
- Audit logging (does not trust application)

**Database layer MUST NOT:**
- Assume application validated request
- Trust request headers or context
- Cache control state beyond TTL
- Permit bypass via configuration
- Disable enforcement temporarily

---

### Non-Negotiable Database Rules

1. Finance tables NEVER permit UPDATE of posted records
2. HR tables NEVER permit UPDATE of executed records
3. Intelligence tables NEVER permit INSERT/UPDATE/DELETE from application
4. Audit tables NEVER permit UPDATE/DELETE from any role
5. Control state unavailable NEVER results in operation approval
6. Trigger failure NEVER results in partial commit
7. Audit logging failure NEVER results in operation proceeding
8. KILL_SWITCH_ACTIVE NEVER permits writes without executive authorization
9. Soft delete NEVER bypassed with hard DELETE on operational tables
10. Superuser NEVER modifies production data outside maintenance windows without audit trail and alert

---

**END OF SPECIFICATION**

---

**Certification Statement:**

This specification defines non-bypassable database layer control enforcement. Implementation is mandatory before production operation. Database triggers, constraints, and role permissions MUST enforce these rules. Quarterly adversarial testing SHALL validate enforcement integrity.

**Approval:**

Chief Technology Officer: _________________________ Date: _________

Database Administrator: _________________________ Date: _________

Chief Information Security Officer: _________________________ Date: _________

---

**Document Control:**

Version: 1.0  
Classification: Internal — Technical Control  
Review Cycle: Quarterly  
Next Review: April 6, 2026
