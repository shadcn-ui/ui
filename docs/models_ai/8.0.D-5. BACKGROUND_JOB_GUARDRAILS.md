# BACKGROUND JOB & ASYNC WORKER CONTROL GUARDRAILS
## Non-Bypassable Execution Enforcement Rules

**Document Classification**: Technical Control Specification — Background Execution  
**Effective Date**: January 6, 2026  
**Authority**: Chief Technology Officer, Chief Information Security Officer  
**Scope**: Background Jobs, Schedulers, Async Workers, Batch Processors

---

## 1. JOB EXECUTION PERMISSIONS

### Control State: NORMAL

**PERMITTED:**
- Read-only jobs (reporting, analytics, data export)
- State-mutating jobs with valid approval context
- Operations domain autonomous jobs below threshold
- Commerce domain autonomous jobs within credit limits
- Retail domain autonomous jobs within policy rules
- ETL jobs moving data between read-only stores
- Sync jobs with external systems (read/write)

**BLOCKED:**
- Finance domain write jobs without approval context
- HR domain write jobs without dual-approval context
- Intelligence domain write jobs (unconditionally)
- Jobs lacking correlation ID
- Jobs lacking control state validation
- Jobs with expired authorization tokens

---

### Control State: SUPERVISED_AUTONOMY

**PERMITTED:**
- Read-only jobs (all types)
- State-mutating jobs with valid approval context
- Operations domain jobs below reduced threshold ($1,000)
- Commerce domain jobs below reduced threshold ($5,000)
- Retail domain jobs below reduced threshold ($500)
- Explicitly authorized write jobs with authorization header

**BLOCKED:**
- Finance domain write jobs without approval context (unchanged)
- HR domain write jobs without dual-approval context (unchanged)
- Intelligence domain write jobs (unchanged)
- Operations/Commerce/Retail autonomous jobs above reduced thresholds
- All jobs not explicitly authorized via authorization registry
- After-hours autonomous jobs unless explicitly whitelisted

---

### Control State: MANUAL_ONLY

**PERMITTED:**
- Read-only jobs (all types)
- State-mutating jobs with valid approval context AND manual execution flag
- Emergency-authorized jobs with executive authorization token

**BLOCKED:**
- ALL autonomous write jobs
- ALL scheduled state-mutating jobs
- ALL cron-triggered write operations
- ALL queue-based write workers
- ALL batch processors performing writes
- ALL ETL jobs performing writes to operational tables
- ALL sync jobs performing writes without approval
- Finance domain write jobs without approval (unchanged)
- HR domain write jobs without dual-approval (unchanged)
- Intelligence domain write jobs (unchanged)

---

### Control State: KILL_SWITCH_ACTIVE

**PERMITTED:**
- Read-only jobs (reporting, analytics, forensic extraction)
- Audit log aggregation jobs
- Monitoring and alerting jobs
- Jobs with executive authorization token (dual-signature)

**BLOCKED:**
- ALL write operations unconditionally
- ALL state-mutating jobs unconditionally
- ALL scheduled jobs performing writes
- ALL queue workers performing writes
- ALL batch processors performing writes
- ALL ETL jobs performing writes
- ALL sync jobs performing writes
- ALL autonomous operations
- Finance domain write jobs (unconditionally)
- HR domain write jobs (unconditionally)
- Intelligence domain write jobs (unchanged)
- Operations domain write jobs (unconditionally)
- Commerce domain write jobs (unconditionally)
- Retail domain write jobs (unconditionally)

---

### Job Category Permanent Blocks

**Finance Domain Jobs — ALWAYS BLOCKED WITHOUT APPROVAL:**
- Journal entry posting jobs
- Account reconciliation jobs
- Period close automation
- Revenue recognition jobs
- Depreciation calculation jobs
- Intercompany elimination jobs
- Financial statement generation jobs (with posting side effects)

**Human Capital Domain Jobs — ALWAYS BLOCKED WITHOUT DUAL-APPROVAL:**
- Payroll calculation jobs
- Payroll execution jobs
- Salary adjustment jobs
- Benefit modification jobs
- Employment status change jobs
- Time and attendance posting jobs

**Intelligence Domain Jobs — ALWAYS BLOCKED FOR WRITES:**
- All write operations to operational databases
- Model training jobs writing to operational tables
- Analytics jobs modifying source data
- Recommendation jobs executing transactions

---

## 2. JOB TYPE CLASSIFICATION

### Read-Only Jobs

**Characteristics:**
- No INSERT/UPDATE/DELETE operations
- No state mutations
- No external system writes
- Query and export only

**Examples:**
- Report generation
- Dashboard data aggregation
- Analytics computation
- Data warehouse ETL (read from operational, write to warehouse)
- Log aggregation
- Monitoring metrics collection

**Permissions:**
- Permitted under ALL control states
- No approval required
- Minimal audit logging (start/end/duration)

---

### State-Mutating Jobs

**Characteristics:**
- Perform INSERT/UPDATE/DELETE operations
- Modify operational data
- Trigger workflows or notifications
- Create financial or operational effects

**Subcategories:**
- Financial-impacting (Finance/HR domains)
- Operational-impacting (Operations/Commerce/Retail domains)
- Cross-domain (multiple domains affected)

**Permissions:**
- Require approval context under MANUAL_ONLY
- Require reduced thresholds under SUPERVISED_AUTONOMY
- Blocked during KILL_SWITCH_ACTIVE
- Subject to domain authority rules

---

### Financial-Impacting Jobs

**Definition:**
- Jobs affecting financial statement balances
- Jobs posting to general ledger
- Jobs generating invoices, receipts, payments
- Jobs calculating revenue, expense, depreciation
- Jobs affecting account balances

**Classification:**
- Finance domain: Level 0 (NEVER autonomous)
- HR domain payroll: Level 0 (NEVER autonomous)

**Permissions:**
- MUST have approval context under ALL control states
- MUST have dual-approval for payroll jobs
- MUST validate approval not expired
- MUST revalidate control state at execution time
- BLOCKED during KILL_SWITCH_ACTIVE unless executive authorization

**Audit Requirements:**
- Full audit trail (job ID, approval ID, affected accounts, amounts, timestamp)
- Approval chain traceability
- Before/after balances logged

---

### External-Facing Jobs

**Subcategories:**
- Sync jobs (bidirectional data exchange)
- Push jobs (outbound data to external systems)
- Pull jobs (inbound data from external systems)
- Webhook handlers (external event processing)

**Sync Jobs (Bidirectional):**
- MUST validate control state before outbound writes
- MUST validate control state before inbound writes
- MUST queue or reject inbound writes during MANUAL_ONLY
- MUST block all writes during KILL_SWITCH_ACTIVE
- MUST maintain idempotency for retry safety

**Push Jobs (Outbound):**
- MUST validate control state before push
- MUST block pushes during KILL_SWITCH_ACTIVE if push triggers external writes
- MUST log all outbound data transfers
- MUST maintain correlation ID chain

**Pull Jobs (Inbound):**
- MUST validate control state before processing inbound data
- MUST queue inbound data during MANUAL_ONLY for manual review
- MUST reject inbound data during KILL_SWITCH_ACTIVE
- MUST validate data against business rules before write

**Webhook Handlers:**
- MUST validate control state at handler execution time
- MUST NOT use stale control state from queue time
- MUST block write operations during restrictive states
- MUST return appropriate HTTP status indicating control state restriction

---

### Jobs NEVER Autonomous

**Finance Domain:**
- Journal posting jobs
- Account reconciliation jobs
- Financial close jobs
- Revenue recognition jobs
- Fixed asset depreciation jobs

**HR Domain:**
- Payroll execution jobs
- Compensation adjustment jobs
- Employment status change jobs
- Benefit enrollment jobs

**High-Risk Operations:**
- Bulk delete jobs
- Mass update jobs affecting >1000 records
- Schema migration jobs
- Data backfill jobs modifying posted records
- Price update jobs affecting >100 products

---

## 3. FAIL-CLOSED RULES

### Control State Read Failure

**Job scheduler cannot read control state:**
- MUST assume KILL_SWITCH_ACTIVE immediately
- MUST block ALL state-mutating jobs
- MUST permit read-only jobs only
- MUST log assumed control state to audit trail
- MUST trigger operational alert to CTO/CISO
- MUST NOT use cached control state older than 5 seconds

**NEVER:**
- Assume NORMAL state
- Proceed with write jobs
- Disable control state checks
- Use stale cached state beyond TTL

---

### Job Guard Check Failure

**Guard validation fails or throws exception:**
- MUST abort job execution immediately
- MUST NOT proceed with partial execution
- MUST log failure to audit trail
- MUST mark job status as FAILED_GUARD_CHECK
- MUST NOT retry automatically
- MUST require manual investigation before retry

**Failure scenarios:**
- Control state validation exception
- Domain authority validation exception
- Approval context validation failure
- Correlation ID missing or invalid
- Authorization token expired or invalid

---

### Scheduler Misconfiguration

**Job definition lacks required metadata:**
- MUST reject job registration
- MUST NOT schedule job for execution
- MUST log configuration error
- MUST alert operations team

**Required metadata:**
- Job type classification (READ_ONLY / STATE_MUTATING)
- Domain classification (Finance/HR/Operations/Commerce/Retail/Intelligence)
- Autonomy level (AUTONOMOUS / SUPERVISED / MANUAL_ONLY)
- Approval requirement (NONE / APPROVAL / DUAL_APPROVAL / EXECUTIVE)
- Idempotency guarantee (IDEMPOTENT / NOT_IDEMPOTENT)
- Retry policy (ALLOW_RETRY / NO_RETRY)

**Missing metadata:**
- Job MUST be classified as most restrictive (STATE_MUTATING, Finance domain, MANUAL_ONLY, DUAL_APPROVAL required)
- Job MUST be blocked until metadata provided

---

### Job Execution Environment Failure

**Job worker infrastructure unavailable:**
- MUST NOT execute jobs
- MUST queue jobs for later execution
- MUST NOT drop jobs silently
- MUST maintain job queue persistence
- MUST log infrastructure failure

**Audit service unavailable:**
- MUST block ALL state-mutating jobs immediately
- MUST permit read-only jobs only
- MUST NOT execute write jobs without audit trail
- MUST trigger critical alert

**Approval service unavailable:**
- MUST block ALL approval-required jobs
- MUST queue jobs for execution after service restoration
- MUST NOT bypass approval requirement
- MUST trigger operational alert

---

## 4. RETRY & IDEMPOTENCY RULES

### Retry Permissions

**ALLOWED to retry:**
- Read-only jobs (always safe to retry)
- Idempotent state-mutating jobs with idempotency key
- Jobs failing due to transient infrastructure errors
- Jobs failing due to temporary resource unavailability

**FORBIDDEN to retry automatically:**
- Non-idempotent financial posting jobs
- Payroll execution jobs (risk of duplicate payment)
- Inventory write-off jobs
- Customer refund jobs
- Non-idempotent external API calls
- Jobs failing due to control state violations
- Jobs failing due to approval validation failures
- Jobs failing due to business rule violations

---

### Retry Validation

**EVERY retry MUST:**
- Revalidate control state at retry time (not queue time)
- Revalidate domain authority at retry time
- Revalidate approval context not expired
- Check idempotency key for duplicate detection
- Increment retry counter in audit trail
- Respect exponential backoff (minimum 1 second, maximum 5 minutes)
- Respect maximum retry limit (5 attempts for transient failures)

**Retry MUST NOT:**
- Use stale control state from original execution attempt
- Skip guard validation because previous attempt passed
- Reset retry counter to hide retry history
- Retry indefinitely without failure escalation

---

### Idempotency Guarantees

**Idempotent Jobs MUST:**
- Include idempotency key in all write operations
- Check idempotency registry before execution
- Record idempotency key before write operation
- Return previous result if duplicate detected
- Maintain idempotency key registry for minimum 7 days

**Non-Idempotent Jobs MUST:**
- Be flagged as NOT_IDEMPOTENT in job metadata
- Block automatic retry
- Require manual investigation before retry
- Log clear warning about duplicate execution risk

---

### Duplicate Prevention

**Financial Jobs MUST:**
- Check for duplicate journal entries via correlation ID
- Reject duplicate posting attempts
- Maintain posted entry registry
- Alert if duplicate financial effect detected

**Payroll Jobs MUST:**
- Check for duplicate payroll execution via payroll period ID
- Reject duplicate payroll for same period
- Maintain payroll execution registry
- Alert if duplicate payroll detected

**Inventory Jobs MUST:**
- Check for duplicate inventory movements via correlation ID
- Reject duplicate transactions
- Maintain inventory transaction registry
- Alert if duplicate inventory effect detected

**External API Jobs MUST:**
- Include idempotency key in all external API calls
- Check for duplicate responses
- Maintain external call registry
- Implement retry with same idempotency key

---

## 5. BYPASS PREVENTION

### Job Privilege Restrictions

**Background jobs MUST NOT:**
- Execute with elevated database privileges
- Use superuser database credentials
- Bypass API Gateway validation
- Bypass Service Layer validation
- Bypass Database Layer triggers
- Modify protected tables directly
- Disable audit logging
- Self-elevate authority levels

**Background jobs MUST:**
- Use standard application database role
- Execute through API Gateway OR implement equivalent validation
- Respect control state at execution time
- Generate audit trail for all operations
- Include correlation ID in all operations
- Be subject to same guardrails as interactive requests

---

### Job Runner Restrictions

**Job execution infrastructure MUST NOT:**
- Provide mechanism to ignore control state
- Provide configuration flag disabling guard checks
- Provide emergency bypass mode
- Allow scheduler admin to override guardrails
- Cache control state beyond 5-second TTL
- Execute jobs during maintenance without validation

**Job execution infrastructure MUST:**
- Validate control state before EVERY job execution
- Enforce guard checks unconditionally
- Log all guard validation results
- Block jobs failing guard validation
- Alert on repeated guard validation failures
- Integrate with Control State Service

---

### Migration and Backfill Jobs

**Database migration jobs MUST:**
- Execute during scheduled maintenance window
- Have change control approval
- Preserve trigger and constraint enforcement
- Maintain audit trail continuity
- NOT modify posted financial records
- NOT modify executed payroll records
- Test in non-production environment first

**Data backfill jobs MUST:**
- Have executive approval for production execution
- Respect immutability rules (no modification of posted records)
- Include approval context for all writes
- Maintain idempotency via backfill registry
- Log all affected records
- Be subject to control state rules (blocked during KILL_SWITCH_ACTIVE)

**Replay jobs (reprocessing historical data) MUST:**
- NOT create duplicate financial effects
- Check for existing transactions before replay
- Use idempotency keys for duplicate detection
- Have approval context for any writes
- Log replay scope and affected records
- Be manually triggered (not scheduled)

---

### Scheduler Configuration Protection

**Job scheduler configuration MUST:**
- Be version controlled
- Require code review for changes
- Require change control approval for production
- Prevent runtime modification without audit trail
- Prevent disabling of guard checks
- Prevent modification of job classification metadata

**Prohibited configuration patterns:**
- Bypass flags (SKIP_CONTROL_CHECK: true)
- Environment variable overrides (DISABLE_GUARDS=1)
- Debug mode exemptions
- Development environment exemptions
- Superuser execution exemptions
- Internal job exemptions

---

## 6. AUDIT & TRACEABILITY

### Job Execution Audit Requirements

**EVERY job execution MUST log:**
- job_execution_id (UUID)
- job_name
- job_type (READ_ONLY / STATE_MUTATING)
- domain (Finance/HR/Operations/Commerce/Retail/Intelligence/System)
- control_state_at_start
- control_state_at_end
- execution_start_timestamp (microsecond precision)
- execution_end_timestamp
- execution_duration_ms
- execution_status (SUCCESS / FAILED_GUARD / FAILED_BUSINESS / FAILED_INFRASTRUCTURE)
- triggered_by (SCHEDULER / MANUAL / WEBHOOK / QUEUE)
- correlation_id
- approval_id (if approval-gated)
- executive_authorization_id (if during KILL_SWITCH_ACTIVE)
- records_read_count
- records_written_count
- records_updated_count
- records_deleted_count
- idempotency_key (if idempotent job)
- retry_count
- previous_execution_id (if retry)

---

### Blocked Job Audit Requirements

**EVERY blocked job MUST log:**
- job_execution_id (UUID)
- job_name
- job_type
- domain
- control_state
- block_timestamp (microsecond precision)
- block_reason_code (CONTROL_STATE_VIOLATION / DOMAIN_AUTHORITY_VIOLATION / APPROVAL_MISSING / KILL_SWITCH_ACTIVE)
- block_reason_detail (human-readable)
- triggered_by
- correlation_id
- approval_id_present (boolean)
- approval_expired (boolean)
- required_approval_type (NONE / APPROVAL / DUAL_APPROVAL / EXECUTIVE)

---

### State-Mutating Job Additional Audit

**State-mutating jobs MUST additionally log:**
- affected_table_list (array of tables written)
- affected_record_ids (array of primary keys for <100 records; count only for bulk operations)
- business_impact_summary (e.g., "Posted 15 journal entries totaling $125,400")
- approval_chain (list of approvers if approval-gated)
- before_snapshot_id (reference to before-state snapshot for rollback capability)
- after_snapshot_id (reference to after-state snapshot for audit trail)

---

### Financial Job Additional Audit

**Financial-impacting jobs MUST additionally log:**
- affected_accounts (list of account codes)
- total_debit_amount
- total_credit_amount
- currency_code
- accounting_period
- posting_date
- journal_entry_ids (if posted journal entries)
- reconciliation_status (RECONCILED / PENDING)

---

### External Sync Job Additional Audit

**External-facing jobs MUST additionally log:**
- external_system_name
- external_system_endpoint
- integration_direction (INBOUND / OUTBOUND / BIDIRECTIONAL)
- external_transaction_id (for correlation with external system)
- records_sent_count
- records_received_count
- external_api_response_status
- external_api_latency_ms
- idempotency_key_sent
- duplicate_detection_result (NEW / DUPLICATE / ERROR)

---

### Forensic Reconstruction Requirements

**Audit trail MUST enable:**
- Complete reconstruction of job execution timeline
- Identification of all state mutations caused by job
- Correlation of job execution to approval workflows
- Correlation of job execution to control state transitions
- Detection of duplicate executions
- Analysis of retry patterns
- Investigation of failed executions
- Validation of control state compliance

**Audit trail MUST support queries:**
- "Which jobs executed during control state X?"
- "Which jobs were blocked due to control state restrictions?"
- "Which jobs modified record Y?"
- "Which financial jobs posted to account Z during period P?"
- "Which jobs executed without required approval?"
- "Which jobs were retried and why?"
- "Which jobs executed during KILL_SWITCH_ACTIVE with executive authorization?"

---

### Audit Log Retention and Immutability

**Job execution audit logs:**
- Minimum 7-year retention for financial jobs
- Minimum 7-year retention for HR jobs
- Minimum 3-year retention for operational jobs
- Permanent retention for KILL_SWITCH_ACTIVE period jobs

**Immutability enforcement:**
- Audit logs stored in append-only tables
- No UPDATE or DELETE permitted on job audit tables
- Triggers prevent modification
- Superuser modifications trigger immediate alert
- Quarterly integrity validation by Internal Audit

**Archive and retrieval:**
- Logs older than 2 years archived to WORM storage
- Archived logs accessible for investigation
- Archive restoration tested quarterly
- External audit validates log integrity

---

## ENFORCEMENT PRINCIPLES

### Job Execution Lifecycle

**1. Pre-Execution Validation:**
- Retrieve current control state
- Retrieve domain authority
- Validate job classification metadata
- Validate approval context (if required)
- Validate idempotency key not duplicate
- Log validation results

**2. Execution Guard:**
- Control state permits job type
- Domain authority permits job actions
- Approval present and not expired (if required)
- Audit logging available
- Correlation ID generated

**3. Execution:**
- Job executes with standard privileges
- All operations subject to API/Service/DB guardrails
- Periodic control state revalidation for long-running jobs
- Audit trail generated continuously

**4. Post-Execution:**
- Log execution result
- Update idempotency registry
- Generate notifications (if required)
- Update job execution history

**5. Failure Handling:**
- Log failure reason
- Classify failure (guard/business/infrastructure)
- Determine retry eligibility
- Alert if repeated failures

---

### Zero-Trust Job Architecture

**Job scheduler MUST NOT trust:**
- Job configuration as authoritative
- Cached control state beyond TTL
- Job self-reported classification
- Job self-reported approval status
- Previous execution results for current authorization

**Job scheduler MUST validate:**
- Control state at execution time
- Domain authority at execution time
- Approval context at execution time
- Idempotency key before execution
- Job classification metadata present

---

### Non-Negotiable Job Rules

1. Background jobs NEVER bypass API/Service/DB guardrails
2. Financial jobs NEVER execute without approval under ANY control state
3. HR jobs NEVER execute without dual-approval under ANY control state
4. Intelligence jobs NEVER perform writes under ANY condition
5. KILL_SWITCH_ACTIVE NEVER permits write jobs without executive authorization
6. Control state failure NEVER results in write job execution
7. Audit logging failure NEVER results in write job execution
8. Non-idempotent jobs NEVER retry automatically
9. Jobs NEVER self-elevate privileges
10. Job configuration NEVER disables guard validation

---

**END OF SPECIFICATION**

---

**Certification Statement:**

This specification defines non-bypassable background job and async worker control enforcement. Implementation is mandatory before production operation. Job scheduler, worker infrastructure, and retry logic MUST enforce these rules. Quarterly adversarial testing SHALL validate enforcement integrity including attempts to bypass controls via scheduled jobs, misconfigured workers, and replay attacks.

**Approval:**

Chief Technology Officer: _________________________ Date: _________

Chief Information Security Officer: _________________________ Date: _________

Director of Engineering: _________________________ Date: _________

---

**Document Control:**

Version: 1.0  
Classification: Internal — Technical Control  
Review Cycle: Quarterly  
Next Review: April 6, 2026
